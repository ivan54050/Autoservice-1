<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Автосервіс Онлайн</title>
<style>
  body {
    margin:0; padding:0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #fff;
    color: #000;
  }
  header {
    background: #000;
    color: white;
    padding: 1rem;
    font-size: 1.6rem;
    font-weight: 600;
    text-align: center;
  }
  nav {
    display: flex;
    background: #fff;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
    overflow-x: auto;
  }
  nav button {
    flex: 1 0 auto;
    border: none;
    background: transparent;
    padding: 0.8rem 1rem;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    color: #444;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  nav button.active {
    color: #000;
    border-bottom: 3px solid #000;
  }
  main {
    padding: 1rem;
    max-width: 900px;
    margin: auto;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  form {
    display: grid;
    gap: 0.8rem;
    margin-bottom: 1.5rem;
  }
  input, select, textarea {
    padding: 0.6rem 0.9rem;
    font-size: 1rem;
    border: 1px solid #000;
    border-radius: 6px;
    background: #fff;
    color: #000;
    resize: vertical;
  }
  button.submit {
    background: #000;
    color: white;
    font-weight: 700;
    border: none;
    padding: 0.7rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    justify-self: start;
    max-width: 150px;
  }
  button.submit:hover {
    background: #222;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  th, td {
    padding: 0.5rem 0.7rem;
    border-bottom: 1px solid #000;
    text-align: left;
    vertical-align: middle;
  }
  th {
    background: #eee;
    font-weight: 700;
    color: #111;
  }
  td button.delete {
    background: #b00020;
    color: white;
    border: none;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background-color 0.3s ease;
  }
  td button.delete:hover {
    background: #800015;
  }
  td button.pdf-btn {
    background: #007a00;
    color: white;
    border: none;
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    margin-right: 0.3rem;
    transition: background-color 0.3s ease;
  }
  td button.pdf-btn:hover {
    background: #004d00;
  }
  @media (max-width: 600px) {
    nav button {
      font-size: 0.9rem;
      padding: 0.6rem 0.8rem;
    }
    input, select, textarea {
      font-size: 1rem;
    }
    table {
      font-size: 0.85rem;
    }
    header {
      font-size: 1.4rem;
      padding: 1rem 0.5rem;
    }
    main {
      padding: 1rem 0.5rem 2rem 0.5rem;
    }
  }
</style>
</head>
<body>

<header>Автосервіс Онлайн</header>

<nav>
  <button class="tab active" data-tab="clients" type="button">Клієнти</button>
  <button class="tab" data-tab="cars" type="button">Автомобілі</button>
  <button class="tab" data-tab="parts" type="button">Запчастини</button>
  <button class="tab" data-tab="invoices" type="button">Рахунки</button>
</nav>

<main>

<section id="clients" class="active" role="tabpanel" aria-label="Клієнти">
  <form id="clientForm">
    <input type="text" id="clientName" placeholder="Ім'я клієнта" required autocomplete="off" />
    <input type="tel" id="clientPhone" placeholder="Телефон" autocomplete="off" />
    <button type="submit" class="submit">Додати клієнта</button>
  </form>
  <table>
    <thead><tr><th>Ім'я</th><th>Телефон</th><th>Видалити</th></tr></thead>
    <tbody id="clientList"></tbody>
  </table>
</section>

<section id="cars" role="tabpanel" aria-label="Автомобілі">
  <form id="carForm">
    <input type="text" id="carClient" placeholder="Власник (клієнт)" required list="clientNames" autocomplete="off"/>
    <input type="text" id="carModel" placeholder="Модель автомобіля" required autocomplete="off"/>
    <input type="text" id="carVIN" placeholder="VIN (опційно)" autocomplete="off"/>
    <button type="submit" class="submit">Додати автомобіль</button>
  </form>
  <datalist id="clientNames"></datalist>
  <table>
    <thead><tr><th>Власник</th><th>Модель</th><th>VIN</th><th>Видалити</th></tr></thead>
    <tbody id="carList"></tbody>
  </table>
</section>

<section id="parts" role="tabpanel" aria-label="Запчастини">
  <form id="partForm">
    <input type="text" id="partName" placeholder="Назва запчастини" required autocomplete="off" />
    <input type="number" id="partPrice" placeholder="Ціна, грн" required min="0" step="0.01" autocomplete="off" />
    <button type="submit" class="submit">Додати запчастину</button>
  </form>
  <table>
    <thead><tr><th>Назва</th><th>Ціна, грн</th><th>Видалити</th></tr></thead>
    <tbody id="partList"></tbody>
  </table>
</section>

<section id="invoices" role="tabpanel" aria-label="Рахунки">
  <form id="invoiceForm">
    <label for="invoiceClient">Клієнт</label>
    <input type="text" id="invoiceClient" required list="clientNames" autocomplete="off" />
    <label for="invoiceCar">Автомобіль</label>
    <select id="invoiceCar" required></select>
    <label for="invoiceParts">Запчастини (Ctrl/Cmd для мультивибору)</label>
    <select id="invoiceParts" multiple size="5"></select>
    <label for="invoiceWork">Роботи</label>
    <textarea id="invoiceWork" placeholder="Опис робіт" required></textarea>
    <label for="invoiceWorkPrice">Вартість робіт, грн</label>
    <input type="number" id="invoiceWorkPrice" min="0" step="0.01" value="0" autocomplete="off" />
    <button type="submit" class="submit">Додати рахунок</button>
  </form>
  <table>
    <thead>
      <tr>
        <th>Клієнт</th>
        <th>Автомобіль</th>
        <th>Запчастини</th>
        <th>Роботи</th>
        <th>Сума, грн</th>
        <th>PDF</th>
        <th>Видалити</th>
      </tr>
    </thead>
    <tbody id="invoiceList"></tbody>
  </table>
</section>

</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
  const { jsPDF } = window.jspdf;

  // Вкладки
  const tabs = document.querySelectorAll('nav button.tab');
  const sections = document.querySelectorAll('main section');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      sections.forEach(s => s.classList.remove('active'));
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  // Дані з localStorage або порожні масиви
  let clients = JSON.parse(localStorage.getItem('clients') || '[]');
  let cars = JSON.parse(localStorage.getItem('cars') || '[]');
  let parts = JSON.parse(localStorage.getItem('parts') || '[]');
  let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');

  // Функції оновлення UI та localStorage
  function saveAll() {
    localStorage.setItem('clients', JSON.stringify(clients));
    localStorage.setItem('cars', JSON.stringify(cars));
    localStorage.setItem('parts', JSON.stringify(parts));
    localStorage.setItem('invoices', JSON.stringify(invoices));
  }

  function updateClientDatalist(){
    const datalist = document.getElementById('clientNames');
    datalist.innerHTML = '';
    clients.forEach(c => {
      const option = document.createElement('option');
      option.value = c.name;
      datalist.appendChild(option);
    });
  }

  function renderClients(){
    const tbody = document.getElementById('clientList');
    tbody.innerHTML = '';
    clients.forEach((c,i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.name}</td><td>${c.phone || ''}</td><td><button class="delete" data-type="client" data-index="${i}" type="button">×</button></td>`;
      tbody.appendChild(tr);
    });
    updateClientDatalist();
  }

  function renderCars(){
    const tbody = document.getElementById('carList');
    tbody.innerHTML = '';
    cars.forEach((c,i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${c.owner}</td><td>${c.model}</td><td>${c.vin || ''}</td><td><button class="delete" data-type="car" data-index="${i}" type="button">×</button></td>`;
      tbody.appendChild(tr);
    });

    // Оновити select авто в рахунках
    const sel = document.getElementById('invoiceCar');
    sel.innerHTML = '';
    cars.forEach((c,i) => {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${c.model} (власник: ${c.owner})`;
      sel.appendChild(option);
    });
  }

  function renderParts(){
    const tbody = document.getElementById('partList');
    tbody.innerHTML = '';
    parts.forEach((p,i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${p.name}</td><td>${p.price.toFixed(2)}</td><td><button class="delete" data-type="part" data-index="${i}" type="button">×</button></td>`;
      tbody.appendChild(tr);
    });

    // Оновити select запчастин в рахунках
    const sel = document.getElementById('invoiceParts');
    sel.innerHTML = '';
    parts.forEach((p,i) => {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = `${p.name} — ${p.price.toFixed(2)} грн`;
      sel.appendChild(option);
    });
  }

  function renderInvoices(){
    const tbody = document.getElementById('invoiceList');
    tbody.innerHTML = '';
    invoices.forEach((inv,i) => {
      const selectedParts = inv.parts.map(idx => parts[idx]?.name || '').filter(n => n).join(', ');
      const partsSum = inv.parts.reduce((sum, idx) => sum + (parts[idx]?.price || 0), 0);
      const workPrice = parseFloat(inv.workPrice) || 0;
      const totalPrice = partsSum + workPrice;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${inv.client}</td>
        <td>${cars[inv.car]?.model || ''}</td>
        <td>${selectedParts}</td>
        <td>${inv.work}</td>
        <td>${totalPrice.toFixed(2)}</td>
        <td><button class="pdf-btn" data-index="${i}" type="button">PDF</button></td>
        <td><button class="delete" data-type="invoice" data-index="${i}" type="button">×</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Початковий рендер
  renderClients();
  renderCars();
  renderParts();
  renderInvoices();

  // Додавання клієнта
  document.getElementById('clientForm').addEventListener('submit', e => {
    e.preventDefault();
    const name = e.target.clientName.value.trim();
    const phone = e.target.clientPhone.value.trim();
    if(name === '') return alert('Вкажіть ім\'я клієнта');
    clients.push({name, phone});
    saveAll();
    renderClients();
    e.target.reset();
  });

  // Додавання авто
  document.getElementById('carForm').addEventListener('submit', e => {
    e.preventDefault();
    const owner = e.target.carClient.value.trim();
    const model = e.target.carModel.value.trim();
    const vin = e.target.carVIN.value.trim();
    if(owner === '' || model === '') return alert('Вкажіть власника та модель авто');
    // Перевірка, чи власник існує
    if(!clients.some(c=> c.name === owner)) return alert('Клієнта не знайдено. Спочатку додайте клієнта.');
    cars.push({owner, model, vin});
    saveAll();
    renderCars();
    e.target.reset();
  });

  // Додавання запчастини
  document.getElementById('partForm').addEventListener('submit', e => {
    e.preventDefault();
    const name = e.target.partName.value.trim();
    const price = parseFloat(e.target.partPrice.value);
    if(name === '' || isNaN(price) || price < 0) return alert('Вкажіть коректні дані запчастини');
    parts.push({name, price});
    saveAll();
    renderParts();
    e.target.reset();
  });

  // Додавання рахунку
  document.getElementById('invoiceForm').addEventListener('submit', e => {
    e.preventDefault();
    const client = e.target.invoiceClient.value.trim();
    const car = parseInt(e.target.invoiceCar.value);
    const selectedParts = Array.from(e.target.invoiceParts.selectedOptions).map(opt => parseInt(opt.value));
    const work = e.target.invoiceWork.value.trim();
    const workPrice = parseFloat(e.target.invoiceWorkPrice.value) || 0;

    if(client === '') return alert('Вкажіть клієнта');
    if(isNaN(car) || !cars[car]) return alert('Вкажіть автомобіль');
    if(work === '') return alert('Опишіть роботи');

    // Перевірка, чи клієнт існує
    if(!clients.some(c => c.name === client)) return alert('Клієнта не знайдено. Додайте клієнта.');

    invoices.push({
      client,
      car,
      parts: selectedParts,
      work,
      workPrice
    });
    saveAll();
    renderInvoices();
    e.target.reset();
  });

  // Обробка кнопок видалення та PDF
  document.body.addEventListener('click', e => {
    if(e.target.classList.contains('delete')) {
      const type = e.target.dataset.type;
      const index = parseInt(e.target.dataset.index);
      if(isNaN(index)) return;
      if(type === 'client') {
        clients.splice(index,1);
        // Видалити авто і рахунки пов'язані з клієнтом
        cars = cars.filter(c => c.owner !== clients[index]?.name);
        invoices = invoices.filter(inv => inv.client !== clients[index]?.name);
      } else if(type === 'car') {
        cars.splice(index,1);
        invoices = invoices.filter(inv => inv.car !== index);
      } else if(type === 'part') {
        parts.splice(index,1);
        invoices.forEach(inv => {
          inv.parts = inv.parts.filter(pIdx => pIdx !== index);
        });
      } else if(type === 'invoice') {
        invoices.splice(index,1);
      }
      saveAll();
      renderClients();
      renderCars();
      renderParts();
      renderInvoices();
    } else if(e.target.classList.contains('pdf-btn')) {
      const index = parseInt(e.target.dataset.index

<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Міні база посилок</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
  </style>
</head>
<body>

<h2>Додати посилку</h2>
<form id="parcelForm">
  <input id="number" placeholder="Номер посилки" required />
  <input id="weight" type="number" step="0.01" placeholder="Вага (кг)" required />
  <input id="places" type="number" min="1" placeholder="Кількість місць" required />
  <div id="volumeContainer"></div>
  <input id="city" placeholder="Місто" required />
  <input id="branch" placeholder="Відділення НП" required />
  <input id="phone" placeholder="Телефон (будь-який формат)" required />
  <input id="price" type="number" step="0.01" placeholder="Ціна в €" required />
  <textarea id="description" placeholder="Опис (необов’язково)"></textarea>
  <button type="submit">Зберегти</button>
</form>

<h2>Посилки</h2>
<table id="parcelTable">
  <thead>
    <tr>
      <th>Номер</th><th>Вага</th><th>Місця</th><th>Обʼємна вага</th><th>Місто</th><th>НП</th><th>Телефон</th><th>Ціна</th><th>Опис</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(async () => {
  const db = await (new Promise((resolve, reject) => {
    const request = indexedDB.open("ParcelsDB", 1);
    request.onupgradeneeded = e => {
      const db = e.target.result;
      db.createObjectStore("parcels", { keyPath: "number" });
    };
    request.onsuccess = e => resolve(e.target.result);
    request.onerror = () => reject();
  }));

  const parcelForm = document.getElementById("parcelForm");
  const volumeContainer = document.getElementById("volumeContainer");
  const placesInput = document.getElementById("places");
  const tableBody = document.querySelector("#parcelTable tbody");

  function renderVolumeFields(count) {
    volumeContainer.innerHTML = "";
    for (let i = 0; i < count; i++) {
      const input = document.createElement("input");
      input.placeholder = `Обʼємна вага місця ${i + 1}`;
      input.type = "number";
      input.step = "0.01";
      input.required = true;
      input.className = "volume";
      volumeContainer.appendChild(input);
    }
  }

  placesInput.addEventListener("input", () => {
    const count = parseInt(placesInput.value || 0);
    if (count > 0) renderVolumeFields(count);
  });

  async function addParcel(data) {
    const tx = db.transaction("parcels", "readwrite");
    const store = tx.objectStore("parcels");
    await store.put(data);
    await tx.complete;
  }

  async function getParcels() {
    const tx = db.transaction("parcels", "readonly");
    const store = tx.objectStore("parcels");
    const request = store.getAll();
    return new Promise(resolve => {
      request.onsuccess = () => resolve(request.result);
    });
  }

  function renderParcels(parcels) {
    tableBody.innerHTML = "";
    for (const p of parcels) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${p.number}</td>
        <td>${p.weight}</td>
        <td>${p.places}</td>
        <td>${p.volume.join(", ")}</td>
        <td>${p.city}</td>
        <td>${p.branch}</td>
        <td>${p.phone}</td>
        <td>${p.price}</td>
        <td>${p.description || ""}</td>
      `;
      tableBody.appendChild(row);
    }
  }

  parcelForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const volumeElems = document.querySelectorAll(".volume");
    const volume = Array.from(volumeElems).map(i => parseFloat(i.value));
    const parcel = {
      number: document.getElementById("number").value.trim(),
      weight: parseFloat(document.getElementById("weight").value),
      places: parseInt(placesInput.value),
      volume,
      city: document.getElementById("city").value.trim(),
      branch: document.getElementById("branch").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      price: parseFloat(document.getElementById("price").value),
      description: document.getElementById("description").value.trim(),
      createdAt: new Date().toISOString()
    };
    await addParcel(parcel);
    const parcels = await getParcels();
    renderParcels(parcels);
    parcelForm.reset();
    volumeContainer.innerHTML = "";
  });

  const existing = await getParcels();
  renderParcels(existing);
})();
</script>

</body>
</html>